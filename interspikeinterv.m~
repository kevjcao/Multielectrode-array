function [isi_histo, isi_3d] = interspikeinterv(raw_units, BW_ISI)
%% Calculate the interspike intervals (ISIs) for each unit

isi_N = cell(numel(raw_units), 1);                                          % generates a cell array of ISIs per uni
isi_edges = cell(numel(raw_units), 1);

for m = 1:length(raw_units)                                                 % generate a histogram of bin size BW_ISI on ISI data from each unit
    [isi_N{m}, isi_edges{m}] = histcounts(raw_units{m}(:,4), 'BinWidth', BW_ISI);
end

max_ISIcell = max(cellfun(@numel, isi_N));
padded_ISIcell = cellfun(@(x) [x zeros(1, max_ISIcell - numel(x))], isi_N, 'un', 0);
padded_ISIs = cell2mat(padded_ISIcell);

%% Create raster of ISI histograms for each unit

isi_histo = figure(6);
hold on;
ISIraster = imagesc(padded_ISIs);

ylabel('Unit');
xlabel('Interspike interval, ms');
xlim([0 20]);                                                               % x-axis limit, scale by BW_ISI (multiply by BW_ISI for time, in ms)
xt = get(gca, 'XTick');
set(gca, 'XTick', xt, 'XTickLabel', xt*BW_ISI);
colorbar;
set(gca, 'TickDir', 'out');
hold off

isi_3d = figure(7);
hold on;
ISI3d = surf(padded_ISIs);

ylabel('Unit');
xlabel('Interspike interval, ms');
zlabel('Counts');
xlim([0 20]); 
xt = get(gca, 'XTick');
set(gca, 'XTick', xt, 'XTickLabel', xt*BW_ISI);
set(gca, 'TickDir', 'out');
hold off

end